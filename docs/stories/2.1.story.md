# Story 2.1: Sine Path Sampler

## Status
Draft

## Story
**As a** user,
**I want** a sine path distribution,
**so that** I can create wavy patterns.

## Acceptance Criteria
1. Sine sampler positions instances along a sine curve with adjustable frequency/amplitude.
2. Works with spacing functions consistently.
3. Deterministic placement given the same parameters.

## Tasks / Subtasks

- [ ] Task 1: Extend PathDistribution type to support sine path (AC: 1)
  - [ ] Update packages/shared/src/types.ts
  - [ ] Add frequency and amplitude fields to PathDistribution.path
  - [ ] Update default Scene to use sine path with default frequency/amplitude
  - [ ] Add type guards for PathType discrimination

- [ ] Task 2: Implement sine path sampler function (AC: 1, 3)
  - [ ] Create apps/web/src/components/engine/sineSampler.ts
  - [ ] Implement sampleSinePath() function
  - [ ] Use frequency parameter to control wave density
  - [ ] Use amplitude parameter to control wave height
  - [ ] Return instances with correct sine wave positions
  - [ ] Ensure deterministic output (same inputs = same outputs)

- [ ] Task 3: Integrate sine sampler into path sampler dispatcher (AC: 1, 2)
  - [ ] Update apps/web/src/components/engine/pathSampler.ts
  - [ ] Add type discrimination to route to correct sampler
  - [ ] Call sampleSinePath() when path.type === 'sine'
  - [ ] Call sampleLinearPath() when path.type === 'linear'
  - [ ] Export unified samplePath() function

- [ ] Task 4: Update Distribution Panel for sine path controls (AC: 1)
  - [ ] Update apps/web/src/components/panels/DistributionPanel.ts
  - [ ] Add path type dropdown (Linear/Sine)
  - [ ] Add frequency slider (0.1 to 5.0 range, step 0.1)
  - [ ] Add amplitude slider (10 to 200 range, step 10)
  - [ ] Conditionally show frequency/amplitude controls when sine selected
  - [ ] Update state when controls change

- [ ] Task 5: Add unit tests for sine sampler (AC: 1, 3)
  - [ ] Create apps/web/tests/sineSampler.test.ts
  - [ ] Test sine wave produces oscillating y positions
  - [ ] Test frequency increases wave density
  - [ ] Test amplitude increases wave height
  - [ ] Test deterministic behavior (same params = same output)
  - [ ] Test edge cases: frequency=0, amplitude=0, frequency=1, amplitude=1

- [ ] Task 6: Add integration tests for sine with spacing (AC: 2)
  - [ ] Update apps/web/tests/multiInstanceRendering.test.ts
  - [ ] Test sine path with linear spacing
  - [ ] Test sine path with ease-in spacing
  - [ ] Test sine path with ease-out spacing
  - [ ] Verify spacing functions apply to sine wave correctly

- [ ] Task 7: Update Renderer to handle sine path (AC: 1, 2)
  - [ ] Update apps/web/src/components/canvas/Renderer.ts
  - [ ] Import samplePath dispatcher instead of sampleLinearPath
  - [ ] Pass complete distribution object to samplePath
  - [ ] Verify sine path renders correctly with spacing functions
  - [ ] Ensure performance remains acceptable with sine path

- [ ] Task 8: Manual verification and visual testing (AC: 1, 2, 3)
  - [ ] Run npm run dev and verify app loads without errors
  - [ ] Verify Distribution panel shows path type dropdown
  - [ ] Select Sine path type
  - [ ] Verify frequency and amplitude controls appear
  - [ ] Set frequency to 1.0 and amplitude to 50
  - [ ] Verify instances follow sine wave pattern
  - [ ] Adjust frequency slider and verify wave density changes
  - [ ] Adjust amplitude slider and verify wave height changes
  - [ ] Test linear spacing with sine path (even horizontal distribution)
  - [ ] Test ease-in spacing with sine path (dense at start)
  - [ ] Test ease-out spacing with sine path (dense at end)
  - [ ] Set instances to 100 and verify smooth sine wave
  - [ ] Verify deterministic: change frequency back to same value produces same pattern
  - [ ] Run npm test and verify all tests pass
  - [ ] Run npm run build and verify production build succeeds

## Dev Notes

### Previous Story Insights

**From Story 1.3 (Spacing Functions):**
- ✅ Complete Scene data model with distribution field
- ✅ PathDistribution type with mode='path' structure
- ✅ Linear path sampler (sampleLinearPath) fully implemented
- ✅ Spacing functions (linear/ease-in/ease-out) working
- ✅ Renderer.ts integrated with path sampler
- ✅ DistributionPanel.ts exists with instances and spacing controls
- ✅ 45 tests passing, performance excellent
- ✅ Deterministic RNG utility available

**Key Files from Story 1.3:**
- packages/shared/src/types.ts - PathDistribution type defined
- apps/web/src/components/engine/pathSampler.ts - Linear sampler exists
- apps/web/src/components/panels/DistributionPanel.ts - Distribution controls UI
- apps/web/src/components/canvas/Renderer.ts - Multi-instance rendering working
- apps/web/src/utils/spacing.ts - Spacing functions available

**Architecture Established:**
- Sampler pattern: pure functions returning Instance[]
- Renderer integration: calls sampler, applies spacing, renders instances
- Panel pattern: Tweakpane with subscribe/update pattern

### Data Model Updates

[Source: architecture/data-models.md#distribution]

**Current PathDistribution (from Story 1.3):**
```typescript
export interface PathDistribution {
  mode: 'path';
  path: {
    type: PathType;
    instances: number;
    frequency?: number; // for sine
    amplitude?: number; // for sine
  };
  spacing: SpacingFn;
}
```

**Update Required:**
- frequency and amplitude already defined as optional (good!)
- Need to add type discrimination in PathDistribution.path.type
- Default values for frequency (1.0) and amplitude (50)

**Updated Types:**
```typescript
// packages/shared/src/types.ts

export type PathType = 'linear' | 'sine';

export interface PathDistribution {
  mode: 'path';
  path: {
    type: PathType;
    instances: number;
    frequency?: number; // for sine waves (waves per full cycle)
    amplitude?: number; // for sine waves (pixel height)
  };
  spacing: SpacingFn;
}
```

**Default Sine Path Configuration:**
```typescript
distribution: {
  mode: 'path',
  path: {
    type: 'sine',
    instances: 20,
    frequency: 1.0, // 1 wave cycle across path
    amplitude: 50, // 50px wave height
  },
  spacing: 'linear',
}
```

### Sine Wave Mathematics

[Source: architecture/components.md#pattern-engine]

**Sine Wave Formula:**
```
y = amplitude * sin(2π * frequency * t)
```

Where:
- `t` ranges from 0 to 1 (normalized parameter along path)
- `frequency` controls how many complete wave cycles fit in path (1.0 = one full wave)
- `amplitude` controls wave height in pixels (50 = ±50px from center)
- `x` position distributed evenly (linear spacing) or with easing (ease-in/ease-out)

**Visual Representation:**
```
frequency = 1.0, amplitude = 50:

     ___     ___
    /   \   /   \
---       -       ----
           \
            \


frequency = 2.0, amplitude = 50:

    /\      /\      /\
---/  \----/  \----/  \---
      \    \    \
       \    \    \
```

### Sine Sampler Implementation

[Source: architecture/components.md#pattern-engine]

**Create sineSampler.ts:**
```typescript
// apps/web/src/components/engine/sineSampler.ts
import type { PathDistribution, Instance } from '@shared/types';

export function sampleSinePath(distribution: PathDistribution): Instance[] {
  const { instances, frequency = 1.0, amplitude = 50 } = distribution.path;
  const result: Instance[] = [];
  
  // For MVP: horizontal line from -300 to 300 (600px span)
  const startX = -300;
  const endX = 300;
  const centerY = 0; // Center vertically
  
  for (let i = 0; i < instances; i++) {
    const t = instances > 1 ? i / (instances - 1) : 0.5; // normalize to 0-1
    
    // Calculate x position (evenly distributed)
    const x = startX + t * (endX - startX);
    
    // Calculate y position using sine wave
    const sineValue = Math.sin(2 * Math.PI * frequency * t);
    const y = centerY + amplitude * sineValue;
    
    result.push({
      x,
      y,
      rotation: 0,
    });
  }
  
  return result;
}
```

**Key Points:**
- Uses Math.sin() for wave generation
- frequency multiplies normalized t parameter
- amplitude scales sine output for pixel height
- Deterministic: same inputs produce same outputs
- Works with spacing functions (applied after sine calculation)

### Path Sampler Dispatcher Updates

[Source: architecture/components.md#pattern-engine]

**Update pathSampler.ts:**
```typescript
// apps/web/src/components/engine/pathSampler.ts
import type { PathDistribution, Instance } from '@shared/types';
import { sampleLinearPath } from './pathSampler';
import { sampleSinePath } from './sineSampler';

export function samplePath(distribution: PathDistribution): Instance[] {
  if (distribution.path.type === 'linear') {
    return sampleLinearPath(distribution);
  } else if (distribution.path.type === 'sine') {
    return sampleSinePath(distribution);
  }
  
  // Fallback to linear
  return sampleLinearPath(distribution);
}

// Keep sampleLinearPath export for backward compatibility
export { sampleLinearPath };
```

**Pattern:**
- Dispatcher function routes to appropriate sampler
- Type-safe discrimination based on path.type
- Fallback to linear for safety

### Distribution Panel Updates

[Source: architecture/frontend-architecture.md#component-architecture]

**Update DistributionPanel.ts:**
```typescript
// apps/web/src/components/panels/DistributionPanel.ts
import { Pane } from 'tweakpane';
import { getState, update, subscribe } from '../../store/store';
import type { Distribution, SpacingFn, PathType } from '@shared/types';

export function DistributionPanel(root: HTMLElement) {
  const pane = new Pane({ container: root, title: 'Distribution' });
  const state = getState();
  
  const d = state.distribution as Extract<Distribution, { mode: 'path' }>;
  
  const params = {
    pathType: d.path.type,
    instances: d.path.instances,
    frequency: d.path.frequency ?? 1.0,
    amplitude: d.path.amplitude ?? 50,
    spacing: d.spacing,
  } as {
    pathType: PathType;
    instances: number;
    frequency: number;
    amplitude: number;
    spacing: SpacingFn;
  };

  // Path type dropdown
  pane.addBinding(params, 'pathType', {
    options: {
      Linear: 'linear',
      Sine: 'sine',
    },
  }).on('change', (ev) => {
    update({
      distribution: {
        ...d,
        path: { ...d.path, type: ev.value },
      } as Distribution,
    });
  });

  // Conditionally show sine controls
  const folder = pane.addFolder({ title: 'Path Controls' });
  
  folder.addBinding(params, 'instances', {
    min: 0,
    max: 2000,
    step: 1,
    label: 'Instances',
  }).on('change', (ev) => {
    update({
      distribution: {
        ...d,
        path: { ...d.path, instances: Math.max(0, Math.floor(ev.value)) },
      } as Distribution,
    });
  });

  if (params.pathType === 'sine') {
    folder.addBinding(params, 'frequency', {
      min: 0.1,
      max: 5.0,
      step: 0.1,
      label: 'Frequency',
    }).on('change', (ev) => {
      update({
        distribution: {
          ...d,
          path: { ...d.path, frequency: ev.value },
        } as Distribution,
      });
    });

    folder.addBinding(params, 'amplitude', {
      min: 10,
      max: 200,
      step: 10,
      label: 'Amplitude',
    }).on('change', (ev) => {
      update({
        distribution: {
          ...d,
          path: { ...d.path, amplitude: ev.value },
        } as Distribution,
      });
    });
  }

  folder.addBinding(params, 'spacing', {
    options: {
      Linear: 'linear',
      'Ease In': 'ease-in',
      'Ease Out': 'ease-out',
    },
  }).on('change', (ev) => {
    update({
      distribution: {
        ...d,
        spacing: ev.value,
      } as Distribution,
    });
  });

  const unsub = subscribe(() => {
    // Reflect external changes if needed
  });
  
  return () => {
    unsub();
    pane.dispose();
  };
}
```

**Key Points:**
- Path type dropdown (Linear/Sine)
- Conditional UI: frequency/amplitude only shown for sine
- Folder organization for better UX
- Update state correctly based on path type

### Renderer Integration Updates

[Source: architecture/components.md#svg-renderer]

**Update Renderer.ts:**
```typescript
// apps/web/src/components/canvas/Renderer.ts
import type { Scene, Instance } from '@shared/types';
import { samplePath } from '../engine/pathSampler'; // Updated import
import { applySpacing } from '../../utils/spacing';

export function renderInstances(svg: SVGSVGElement, scene: Scene) {
  let instanceGroup = svg.querySelector('#instances') as SVGGElement;
  
  if (!instanceGroup) {
    instanceGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    instanceGroup.id = 'instances';
    svg.appendChild(instanceGroup);
  }
  
  instanceGroup.innerHTML = '';
  
  let instances: Instance[] = [];
  
  if (scene.distribution.mode === 'path') {
    // Use dispatcher instead of direct sampler call
    instances = samplePath(scene.distribution);
    
    // Apply spacing function
    const spacedPositions = applySpacing(
      instances.map(i => ({ x: i.x, y: i.y })),
      scene.distribution.spacing
    );
    
    instances = instances.map((inst, i) => ({
      ...inst,
      x: spacedPositions[i].x,
    }));
  }
  
  // ... rest of render logic unchanged
}
```

**Key Changes:**
- Import `samplePath` dispatcher instead of `sampleLinearPath`
- Call dispatcher which routes to correct sampler
- No other changes needed (spacing functions work transparently)

### Testing Strategy

[Source: architecture/testing-strategy.md]

**Test Organization:**
```
apps/web/tests/
  sineSampler.test.ts        # New: Sine sampler unit tests
  multiInstanceRendering.test.ts # Update: Sine integration tests
```

**Unit Test Patterns:**

**Sine Sampler Test Example:**
```typescript
import { describe, it, expect } from 'vitest';
import { sampleSinePath } from '../src/components/engine/sineSampler';
import type { PathDistribution } from '@shared/types';

describe('Sine Sampler', () => {
  it('produces oscillating y positions', () => {
    const dist: PathDistribution = {
      mode: 'path',
      path: {
        type: 'sine',
        instances: 10,
        frequency: 1.0,
        amplitude: 50,
      },
      spacing: 'linear',
    };
    
    const instances = sampleSinePath(dist);
    
    expect(instances).toHaveLength(10);
    // First instance should be near top (y < 0)
    expect(instances[0].y).toBeLessThan(0);
    // Middle instance should be near bottom (y > 0)
    expect(instances[5].y).toBeGreaterThan(0);
    // Last instance should be near top again (y < 0)
    expect(instances[9].y).toBeLessThan(0);
  });

  it('increases wave density with higher frequency', () => {
    const dist1: PathDistribution = {
      mode: 'path',
      path: { type: 'sine', instances: 10, frequency: 1.0, amplitude: 50 },
      spacing: 'linear',
    };
    
    const dist2: PathDistribution = {
      mode: 'path',
      path: { type: 'sine', instances: 10, frequency: 2.0, amplitude: 50 },
      spacing: 'linear',
    };
    
    const instances1 = sampleSinePath(dist1);
    const instances2 = sampleSinePath(dist2);
    
    // Higher frequency should have more oscillations
    // Check crossing count: frequency=2 should have more sign changes
    const signChanges1 = instances1.filter((inst, i) => 
      i > 0 && Math.sign(inst.y) !== Math.sign(instances1[i-1].y)
    ).length;
    
    const signChanges2 = instances2.filter((inst, i) => 
      i > 0 && Math.sign(inst.y) !== Math.sign(instances2[i-1].y)
    ).length;
    
    expect(signChanges2).toBeGreaterThan(signChanges1);
  });

  it('increases wave height with higher amplitude', () => {
    const dist1: PathDistribution = {
      mode: 'path',
      path: { type: 'sine', instances: 10, frequency: 1.0, amplitude: 10 },
      spacing: 'linear',
    };
    
    const dist2: PathDistribution = {
      mode: 'path',
      path: { type: 'sine', instances: 10, frequency: 1.0, amplitude: 100 },
      spacing: 'linear',
    };
    
    const instances1 = sampleSinePath(dist1);
    const instances2 = sampleSinePath(dist2);
    
    // Higher amplitude should have larger y variations
    const range1 = Math.max(...instances1.map(i => i.y)) - Math.min(...instances1.map(i => i.y));
    const range2 = Math.max(...instances2.map(i => i.y)) - Math.min(...instances2.map(i => i.y));
    
    expect(range2).toBeGreaterThan(range1);
  });

  it('is deterministic (same inputs produce same outputs)', () => {
    const dist: PathDistribution = {
      mode: 'path',
      path: { type: 'sine', instances: 20, frequency: 1.5, amplitude: 75 },
      spacing: 'linear',
    };
    
    const result1 = sampleSinePath(dist);
    const result2 = sampleSinePath(dist);
    
    expect(result1).toEqual(result2);
  });
});
```

**Integration Test Example:**
```typescript
import { describe, it, expect } from 'vitest';
import { renderInstances } from '../src/components/canvas/Renderer';
import { createTestScene } from './helpers';

describe('Sine Path Integration', () => {
  it('renders sine path with linear spacing', () => {
    const scene = createTestScene({
      distribution: {
        mode: 'path',
        path: { type: 'sine', instances: 20, frequency: 1.0, amplitude: 50 },
        spacing: 'linear',
      },
    });
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    renderInstances(svg, scene);
    
    const useElements = svg.querySelectorAll('use');
    expect(useElements).toHaveLength(20);
  });

  it('applies ease-in spacing to sine path', () => {
    const scene = createTestScene({
      distribution: {
        mode: 'path',
        path: { type: 'sine', instances: 20, frequency: 1.0, amplitude: 50 },
        spacing: 'ease-in',
      },
    });
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    renderInstances(svg, scene);
    
    const useElements = svg.querySelectorAll('use');
    expect(useElements).toHaveLength(20);
    // First few instances should be closer together (ease-in effect)
  });
});
```

### Coding Standards Reminders

[Source: architecture/coding-standards.md]

**Naming Conventions:**
- Components: PascalCase — `SineSampler.ts`
- Utilities: camelCase — `sineSampler.ts` (source files)
- Functions: camelCase — `sampleSinePath()`
- Constants: UPPER_SNAKE_CASE — `TWO_PI`

**Critical Rules for Story 2.1:**
- **Type Sharing**: All types in `packages/shared/src/types.ts`
- **Pure Functions**: Sine sampler must be pure (no side effects)
- **Deterministic**: Same inputs produce same outputs
- **Compatibility**: Sine sampler must work with existing spacing functions

### Performance Considerations

[Source: architecture/high-level-architecture.md]

**Performance Impact:**
- Sine calculation: O(n) where n = instances
- Math.sin() call per instance (acceptable for 1-2k instances)
- No additional DOM overhead compared to linear path
- Spacing functions apply to sine paths transparently

**Optimization:**
- Same DocumentFragment batching from Story 1.3
- No new performance concerns
- Maintain 60fps @ 1k instances, 30fps @ 2k instances

### File Locations Summary

**Files to Create:**

1. **apps/web/src/components/engine/sineSampler.ts** (new)
   - sampleSinePath() function

2. **apps/web/tests/sineSampler.test.ts** (new)
   - Sine sampler unit tests

**Files to Update:**

1. **packages/shared/src/types.ts**
   - PathType already defined
   - No changes needed (frequency/amplitude already optional)

2. **apps/web/src/components/engine/pathSampler.ts**
   - Add samplePath() dispatcher function
   - Import sampleSinePath

3. **apps/web/src/components/panels/DistributionPanel.ts**
   - Add path type dropdown
   - Add conditional frequency/amplitude controls

4. **apps/web/src/components/canvas/Renderer.ts**
   - Update import to use samplePath dispatcher

5. **apps/web/tests/multiInstanceRendering.test.ts**
   - Add sine path integration tests

### Acceptance Criteria Implementation Notes

**AC 1: Sine sampler positions instances along a sine curve with adjustable frequency/amplitude**
- Implemented by Tasks 2-4: Sine sampler with frequency/amplitude parameters
- Verified by Task 5: Unit tests verify oscillating positions and parameter effects
- Visual Verification: Manual testing shows smooth sine wave pattern

**AC 2: Works with spacing functions consistently**
- Implemented by Task 3: Sampler dispatcher maintains spacing function compatibility
- Verified by Task 6: Integration tests verify spacing works with sine path
- Compatibility: Sine uses same Instance[] return type as linear

**AC 3: Deterministic placement given the same parameters**
- Implemented by Task 2: Pure function with no randomness
- Verified by Task 5: Unit tests verify deterministic behavior
- Mathematical: Math.sin() is deterministic for same inputs

### Integration with Existing Components

**Path Sampler Integration:**
- Current linear sampler remains unchanged
- New dispatcher routes to appropriate sampler
- Backward compatible (sampleLinearPath still exported)

**Distribution Panel Integration:**
- Conditional UI based on path type
- Follows existing Tweakpane pattern
- Maintains subscribe/update pattern

**Renderer Integration:**
- Minimal changes (import update only)
- No performance impact
- Works transparently with existing spacing functions

### Debug and Verification Helpers

**For Manual Testing:**

1. **Browser Console Commands:**
```javascript
// Inspect current distribution
window.__debugState = () => console.log(getState().distribution);

// Verify sine pattern
const instances = sampleSinePath(getState().distribution);
console.log('First few y positions:', instances.slice(0, 5).map(i => i.y));
```

2. **Visual Verification:**
- Sine wave should oscillate smoothly
- Higher frequency = more wave cycles
- Higher amplitude = taller waves
- Spacing functions should affect horizontal distribution only

3. **Edge Case Testing:**
- frequency = 0: Flat line (should handle gracefully)
- amplitude = 0: Flat line
- frequency > 5: Very dense waves (may appear noisy)
- amplitude > 200: Very tall waves (may extend beyond canvas)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-29 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record

This section will be populated by the development agent during implementation.

### Agent Model Used

(To be filled by Dev Agent)

### Debug Log References

(To be filled by Dev Agent)

### Completion Notes List

(To be filled by Dev Agent)

### File List

(To be filled by Dev Agent)

## QA Results

(To be filled by QA Agent)

